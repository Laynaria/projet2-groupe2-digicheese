services:
  db:
    healthcheck:
      test: ["CMD-SHELL", "mysqladmin ping -h 127.0.0.1 -u$$MYSQL_USER -p$$MYSQL_PASSWORD --silent"]
      interval: 5s
      timeout: 3s
      retries: 30
      start_period: 20s

  fastapi:
    # En CI on veut un process simple/stable, pas de reload
    command: ["uvicorn", "api.main:app", "--host", "0.0.0.0", "--port", "80"]
    # En CI, pas besoin des volumes (et ça évite des effets de bord)
    volumes: []
    depends_on:
      db:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "python -c \"import urllib.request; urllib.request.urlopen('http://127.0.0.1:80/docs').read()\""]
      interval: 5s
      timeout: 5s
      retries: 30
      start_period: 20s

  tests:
    build:
      context: .
      dockerfile: Dockerfile
    working_dir: /code
    volumes: []
    depends_on:
      db:
        condition: service_healthy
    # On lance pytest sans démarrer l’API
    entrypoint: ["/bin/sh", "-lc"]
    command: >
      pip install -q pytest pytest-cov &&
      mkdir -p /code/reports &&
      pytest -v
      --junitxml=/code/reports/pytest-junit.xml
      --cov=api
      --cov-report=xml:/code/reports/coverage.xml
      --cov-report=term
      --cov-report=html:/code/reports/htmlcov
