name: CI - Tests unitaires + Perf (k6) + KPI

on:
  push:
    branches: [ "main", "tb_ci_cd" ]
  pull_request:

jobs:
  unit-tests:
    name: Unit tests (pytest in Docker)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Start services with docker compose
        env:
          # JWT Configuration
          SECRET_KEY: "test-secret-key-for-ci-only"
          ALGORITHM: "HS256"
          ACCESS_TOKEN_EXPIRE_MINUTES: "30"

          # Database Configuration
          USER: "admin"
          PASSWORD: "Admin123!"
          DATABASE: "digicheese"
          MYSQL_ROOT_PASSWORD: "securepassword"

          # Seed (dÃ©sactivÃ© pour les tests unitaires)
          SEED_DB: "false"
          SEED_ADMIN: "false"
        run: |
          echo "ðŸš€ Starting services..."
          docker compose up -d --build
          
          echo "â³ Waiting for services to be ready..."
          sleep 15
          
          echo "ðŸ“Š Services status:"
          docker compose ps

      - name: Wait for MariaDB to be ready
        run: |
          echo "ðŸ” Waiting for MariaDB..."
          for i in {1..30}; do
            if docker compose exec -T db mysqladmin ping -h localhost -u admin -pAdmin123! --silent 2>/dev/null; then
              echo "âœ“ MariaDB is ready"
              exit 0
            fi
            echo "Waiting for MariaDB... ($i/30)"
            sleep 3
          done
          echo "âŒ MariaDB did not become ready"
          docker compose logs db
          exit 1

      - name: Install test dependencies in container
        run: |
          echo "ðŸ“¦ Installing pytest and coverage tools..."
          docker compose exec -T fastapi pip install pytest pytest-cov

      - name: Run pytest in Docker container
        run: |
          echo "ðŸ§ª Running tests in Docker container..."
          mkdir -p reports
          docker compose exec -T fastapi pytest -v \
            --junitxml=/code/reports/pytest-junit.xml \
            --cov=api \
            --cov-report=xml:/code/reports/coverage.xml \
            --cov-report=term \
            --cov-report=html:/code/reports/htmlcov

      - name: Copy test reports from container
        if: always()
        run: |
          echo "ðŸ“‹ Copying reports from container..."
          docker cp $(docker compose ps -q fastapi):/code/reports ./reports || {
            echo "âš ï¸  Could not copy reports, trying alternative method..."
            mkdir -p reports
          }

      - name: Display test summary
        if: always()
        run: |
          if [ -f "reports/pytest-junit.xml" ]; then
            echo "âœ… Tests completed - check artifacts for details"
          else
            echo "âš ï¸  No test report found"
          fi

      - name: Upload test reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: unit-test-reports
          path: reports/
          retention-days: 30

      - name: Upload coverage report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: reports/htmlcov/
          retention-days: 30

      - name: Comment PR with coverage
        if: github.event_name == 'pull_request' && hashFiles('reports/coverage.xml') != ''
        uses: orgoro/coverage@v3.1
        with:
          coverageFile: reports/coverage.xml
          token: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true

      - name: Stop containers (keep for perf tests)
        run: |
          echo "â¸ï¸  Keeping containers running for performance tests..."


  perf-tests:
    name: Performance tests (k6) + KPI report
    runs-on: ubuntu-latest
    needs: unit-tests

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Start API with docker compose
        env:
          # Seed Configuration (activÃ© pour les tests de performance)
          SEED_DB: "true"
          SEED_ADMIN: "true"
          ADMIN_EMAIL: "admin@digicheese.com"
          ADMIN_PASSWORD: "Admin123!"

          # JWT Configuration
          SECRET_KEY: "test-secret-key-for-ci-only"
          ALGORITHM: "HS256"
          ACCESS_TOKEN_EXPIRE_MINUTES: "30"

          # Database Configuration
          USER: "admin"
          PASSWORD: "Admin123!"
          DATABASE: "digicheese"
          MYSQL_ROOT_PASSWORD: "securepassword"
        run: |
          echo "ðŸš€ Starting services with seeding enabled..."
          docker compose up -d --build
          
          echo "â³ Waiting for services..."
          sleep 20
          
          echo "ðŸ“Š Container status:"
          docker compose ps
          
          echo "ðŸ“ Recent logs:"
          docker compose logs --tail=30 fastapi

      - name: Wait for API health
        run: |
          echo "ðŸ” Checking API health..."
          for i in {1..60}; do
            if curl -sSf http://localhost:8000/docs > /dev/null 2>&1; then
              echo "âœ“ API is up and responding"
              exit 0
            fi
            echo "Waiting for API... ($i/60)"
            sleep 3
          done
          
          echo "âŒ API did not start in time"
          echo "=== FastAPI Logs ==="
          docker compose logs fastapi --tail=100
          echo "=== MariaDB Logs ==="
          docker compose logs db --tail=50
          exit 1

      - name: Verify API endpoints
        run: |
          echo "ðŸ§ª Testing API connectivity..."
          curl -v http://localhost:8000/docs 2>&1 | head -20 || true

      - name: Create performance results directory
        run: |
          mkdir -p performance/results reports
          chmod -R 777 performance/results reports

      - name: Run k6 - 10 VUs (baseline)
        run: |
          echo "ðŸ“Š Running k6 with 10 VUs..."
          docker run --rm --network host \
            -v "${PWD}:/work" -w /work \
            grafana/k6 run performance/test.js \
            --vus 10 \
            --duration 30s \
            -e BASE_URL="http://localhost:8000" \
            -e API_PREFIX="/api/v1" \
            -e EMAIL="admin@digicheese.com" \
            -e PASSWORD="Admin123!" \
            --out json=performance/results/k6_10.json \
            --summary-export=performance/results/summary_10.json

      - name: Run k6 - 50 VUs (standard load)
        run: |
          echo "ðŸ“Š Running k6 with 50 VUs..."
          docker run --rm --network host \
            -v "${PWD}:/work" -w /work \
            grafana/k6 run performance/test.js \
            --vus 50 \
            --duration 30s \
            -e BASE_URL="http://localhost:8000" \
            -e API_PREFIX="/api/v1" \
            -e EMAIL="admin@digicheese.com" \
            -e PASSWORD="Admin123!" \
            --out json=performance/results/k6_50.json \
            --summary-export=performance/results/summary_50.json

      - name: Run k6 - 100 VUs (stress test)
        continue-on-error: true
        run: |
          echo "ðŸ“Š Running k6 with 100 VUs (stress test)..."
          docker run --rm --network host \
            -v "${PWD}:/work" -w /work \
            grafana/k6 run performance/test.js \
            --vus 100 \
            --duration 30s \
            -e BASE_URL="http://localhost:8000" \
            -e API_PREFIX="/api/v1" \
            -e EMAIL="admin@digicheese.com" \
            -e PASSWORD="Admin123!" \
            --out json=performance/results/k6_100.json \
            --summary-export=performance/results/summary_100.json || {
              echo "âš ï¸  100 VUs test failed (expected for stress test)"
              exit 0
            }

      - name: Set up Python for report generation
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Python dependencies for reports
        run: |
          pip install --upgrade pip
          pip install pandas tabulate 2>/dev/null || echo "âš ï¸  Optional dependencies not installed"

      - name: Generate KPI report
        run: |
          echo "ðŸ“Š Generating performance report..."
          
          if [ -f "performance/ci/parse_k6.py" ]; then
            python performance/ci/parse_k6.py \
              --input performance/results \
              --output reports || {
                echo "âš ï¸  Report generation failed, creating fallback"
                cat > reports/REPORT.md << 'EOF'
          # ðŸ“Š Performance Test Results
          
          Tests completed successfully. See artifacts for detailed JSON results.
          
          ## Test Scenarios
          - âœ… 10 VUs (baseline)
          - âœ… 50 VUs (standard load)
          - âš ï¸ 100 VUs (stress test - may have warnings)
          EOF
              }
          else
            echo "â„¹ï¸  parse_k6.py not found, creating basic report"
            cat > reports/REPORT.md << 'EOF'
          # ðŸ“Š Performance Test Results
          
          Performance tests completed. Check artifacts for detailed results.
          EOF
          fi

      - name: Display report
        if: always()
        run: |
          if [ -f "reports/REPORT.md" ]; then
            echo "=== Performance Report ==="
            cat reports/REPORT.md
          fi

      - name: Comment PR with KPI
        if: github.event_name == 'pull_request' && hashFiles('reports/REPORT.md') != ''
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          path: reports/REPORT.md
          header: performance-results
        continue-on-error: true

      - name: Upload performance artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: perf-reports
          path: |
            performance/results/*.json
            reports/*.md
          retention-days: 30

      - name: Display logs on failure
        if: failure()
        run: |
          echo "=== FastAPI Logs ==="
          docker compose logs fastapi --tail=200
          echo "=== MariaDB Logs ==="
          docker compose logs db --tail=100

      - name: Cleanup
        if: always()
        run: |
          echo "ðŸ§¹ Cleaning up..."
          docker compose down -v
          docker system prune -f || true