name: CI - Tests unitaires + Perf (k6) + KPI

on:
  push:
    branches: ["main", "tb_ci_cd"]
  pull_request:

env:
  SECRET_KEY: "test-secret-key-for-ci-only"
  ALGORITHM: "HS256"
  ACCESS_TOKEN_EXPIRE_MINUTES: "30"
  USER: "admin"
  PASSWORD: "Admin123!"
  DATABASE: "digicheese"
  MYSQL_ROOT_PASSWORD: "securepassword"

jobs:
  unit-tests:
    name: Unit tests (pytest in Docker)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Create CI env file (override any repo .env)
        run: |
          cat > .ci.env << 'EOF'
          SECRET_KEY=test-secret-key-for-ci-only
          ALGORITHM=HS256
          ACCESS_TOKEN_EXPIRE_MINUTES=30
          USER=admin
          PASSWORD=Admin123!
          DATABASE=digicheese
          MYSQL_ROOT_PASSWORD=securepassword

          # Important: pas de seed sur les unit tests
          SEED_DB=false
          SEED_ADMIN=false
          EOF

      - name: Build images
        run: |
          docker compose --env-file .ci.env -f docker-compose.yml -f docker-compose.ci.yml build

      - name: Start DB (healthy)
        run: |
          docker compose --env-file .ci.env -f docker-compose.yml -f docker-compose.ci.yml up -d db
          docker compose --env-file .ci.env -f docker-compose.yml -f docker-compose.ci.yml ps
          docker compose --env-file .ci.env -f docker-compose.yml -f docker-compose.ci.yml logs db --tail=200

      - name: Run pytest (service tests)
        run: |
          mkdir -p reports
          docker compose --env-file .ci.env -f docker-compose.yml -f docker-compose.ci.yml run --rm tests

      - name: Copy test reports from container volume-less run
        if: always()
        run: |
          # On rÃ©cupÃ¨re les reports depuis l'image "tests" en relanÃ§ant un conteneur Ã©phÃ©mÃ¨re qui cat le dossier
          # Plus robuste que docker cp sur un conteneur dÃ©jÃ  supprimÃ©
          id=$(docker create $(docker compose --env-file .ci.env -f docker-compose.yml -f docker-compose.ci.yml images -q tests) sh -lc "ls -la /code/reports && true")
          docker cp "$id:/code/reports" ./reports 2>/dev/null || true
          docker rm -f "$id" >/dev/null 2>&1 || true

      - name: Upload test reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: unit-test-reports
          path: reports/
          retention-days: 30
          if-no-files-found: warn

      - name: Upload coverage report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: reports/htmlcov/
          retention-days: 30
          if-no-files-found: warn

      - name: Comment PR with coverage
        if: github.event_name == 'pull_request' && hashFiles('reports/coverage.xml') != ''
        uses: orgoro/coverage@v3.1
        with:
          coverageFile: reports/coverage.xml
          token: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true

      - name: Display logs on failure
        if: failure()
        run: |
          echo "=== DB Logs ==="
          docker compose --env-file .ci.env -f docker-compose.yml -f docker-compose.ci.yml logs db --tail=300
          echo ""
          echo "=== Compose PS ==="
          docker compose --env-file .ci.env -f docker-compose.yml -f docker-compose.ci.yml ps

      - name: Cleanup after unit tests
        if: always()
        run: |
          docker compose --env-file .ci.env -f docker-compose.yml -f docker-compose.ci.yml down -v


  perf-tests:
    name: Performance tests (k6) + KPI report
    runs-on: ubuntu-latest
    needs: unit-tests

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Create CI env file (seed enabled)
        run: |
          cat > .ci.env << 'EOF'
          SECRET_KEY=test-secret-key-for-ci-only
          ALGORITHM=HS256
          ACCESS_TOKEN_EXPIRE_MINUTES=30
          USER=admin
          PASSWORD=Admin123!
          DATABASE=digicheese
          MYSQL_ROOT_PASSWORD=securepassword

          # Seed pour perf
          SEED_DB=true
          SEED_ADMIN=true
          ADMIN_EMAIL=admin@digicheese.com
          ADMIN_PASSWORD=Admin123!
          EOF

      - name: Build images
        run: |
          docker compose --env-file .ci.env -f docker-compose.yml -f docker-compose.ci.yml build

      - name: Start stack (db + api) and wait healthy
        run: |
          docker compose --env-file .ci.env -f docker-compose.yml -f docker-compose.ci.yml up -d db fastapi
          echo "=== Compose PS ==="
          docker compose --env-file .ci.env -f docker-compose.yml -f docker-compose.ci.yml ps
          echo "=== FastAPI Logs (tail) ==="
          docker compose --env-file .ci.env -f docker-compose.yml -f docker-compose.ci.yml logs fastapi --tail=200

          echo "Waiting for FastAPI healthcheck..."
          for i in {1..60}; do
            status=$(docker inspect --format='{{json .State.Health.Status}}' $(docker compose --env-file .ci.env -f docker-compose.yml -f docker-compose.ci.yml ps -q fastapi) 2>/dev/null || echo "\"unknown\"")
            if [ "$status" = "\"healthy\"" ]; then
              echo "âœ“ FastAPI healthy"
              break
            fi
            if [ "$i" -eq 60 ]; then
              echo "âŒ FastAPI not healthy in time"
              docker compose --env-file .ci.env -f docker-compose.yml -f docker-compose.ci.yml logs fastapi --tail=400
              docker compose --env-file .ci.env -f docker-compose.yml -f docker-compose.ci.yml logs db --tail=200
              exit 1
            fi
            sleep 3
          done

      - name: Test API endpoints
        run: |
          curl -v http://localhost:8000/docs 2>&1 | head -40

      - name: Prepare performance test directories
        run: |
          mkdir -p performance/results reports
          chmod -R 777 performance/results reports

      - name: Run k6 performance tests
        run: |
          run_k6_test() {
            local vus=$1
            local duration=$2
            local label=$3

            echo ""
            echo "ðŸ“Š Running k6 with ${vus} VUs (${label})..."
            docker run --rm --network host \
              -v "${PWD}:/work" -w /work \
              grafana/k6 run performance/test.js \
              --vus ${vus} \
              --duration ${duration} \
              -e BASE_URL="http://localhost:8000" \
              -e API_PREFIX="/api/v1" \
              -e EMAIL="admin@digicheese.com" \
              -e PASSWORD="Admin123!" \
              --out json=performance/results/k6_${vus}.json \
              --summary-export=performance/results/summary_${vus}.json
          }

          run_k6_test 10 30s "baseline"
          run_k6_test 50 30s "standard load"
          run_k6_test 100 30s "stress test" || echo "âš ï¸ 100 VUs test failed (acceptable for stress)"

      - name: Set up Python for KPI report
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Generate KPI report
        run: |
          pip install --upgrade pip
          pip install pandas tabulate 2>/dev/null || true

          create_fallback_report() {
            cat > reports/REPORT.md << 'EOF'
          # ðŸ“Š Performance Test Results

          Performance tests completed.

          ## Scenarios
          - âœ… 10 VUs baseline
          - âœ… 50 VUs standard load
          - âš ï¸ 100 VUs stress (may fail)

          Detailed JSON outputs are available in artifacts.
          EOF
          }

          if [ -f "performance/ci/parse_k6.py" ]; then
            python performance/ci/parse_k6.py --input performance/results --output reports || create_fallback_report
          else
            create_fallback_report
          fi

      - name: Display generated report
        if: always()
        run: |
          test -f reports/REPORT.md && cat reports/REPORT.md || true

      - name: Comment PR with performance results
        if: github.event_name == 'pull_request' && hashFiles('reports/REPORT.md') != ''
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          path: reports/REPORT.md
          header: performance-kpi
        continue-on-error: true

      - name: Upload performance artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: perf-reports
          path: |
            performance/results/
            reports/
          retention-days: 30

      - name: Display logs on failure
        if: failure()
        run: |
          echo "=== FastAPI Logs ==="
          docker compose --env-file .ci.env -f docker-compose.yml -f docker-compose.ci.yml logs fastapi --tail=400
          echo ""
          echo "=== MariaDB Logs ==="
          docker compose --env-file .ci.env -f docker-compose.yml -f docker-compose.ci.yml logs db --tail=200
          echo ""
          echo "=== Container Status ==="
          docker compose --env-file .ci.env -f docker-compose.yml -f docker-compose.ci.yml ps

      - name: Cleanup
        if: always()
        run: |
          docker compose --env-file .ci.env -f docker-compose.yml -f docker-compose.ci.yml down -v
          docker system prune -f || true
