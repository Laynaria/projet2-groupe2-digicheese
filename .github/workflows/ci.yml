name: CI - Tests unitaires + Perf (k6) + KPI

on:
  push:
    branches: [ "main", "tb_ci_cd" ]
  pull_request:

env:
  # Configuration commune pour tous les jobs
  SECRET_KEY: "test-secret-key-for-ci-only"
  ALGORITHM: "HS256"
  ACCESS_TOKEN_EXPIRE_MINUTES: "30"
  USER: "admin"
  PASSWORD: "Admin123!"
  DATABASE: "digicheese"
  MYSQL_ROOT_PASSWORD: "securepassword"

jobs:
  unit-tests:
    name: Unit tests (pytest in Docker)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Start database first
        env:
          SEED_DB: "false"
          SEED_ADMIN: "false"
        run: |
          echo "ðŸ—„ï¸ Starting MariaDB first..."
          docker compose up -d db
          
          echo "â³ Waiting for MariaDB to be fully ready..."
          for i in {1..60}; do
            if docker compose exec -T db mysqladmin ping -h localhost -u admin -pAdmin123! --silent 2>/dev/null; then
              echo "âœ“ MariaDB is ready ($i attempts)"
              break
            fi
            if [ $i -eq 60 ]; then
              echo "âŒ MariaDB failed to start"
              docker compose logs db
              exit 1
            fi
            sleep 2
          done
          
          # Attente supplÃ©mentaire pour stabilisation
          echo "â³ Additional wait for MariaDB stabilization..."
          sleep 5

      - name: Start FastAPI application
        env:
          SEED_DB: "false"
          SEED_ADMIN: "false"
        run: |
          echo "ðŸš€ Starting FastAPI..."
          docker compose up -d --build fastapi
          
          echo "â³ Waiting for FastAPI to start..."
          sleep 10
          
          echo "ðŸ“Š Services status:"
          docker compose ps
          
          echo "ðŸ“ FastAPI logs:"
          docker compose logs fastapi --tail=30

      - name: Verify services health
        run: |
          echo "ðŸ” Verifying all services..."
          
          # VÃ©rifier MariaDB
          if ! docker compose exec -T db mysqladmin ping -h localhost -u admin -pAdmin123! --silent; then
            echo "âŒ MariaDB health check failed"
            docker compose logs db
            exit 1
          fi
          
          # VÃ©rifier FastAPI
          if ! docker compose exec -T fastapi python -c "from api.database import engine; engine.connect()" 2>/dev/null; then
            echo "âš ï¸ FastAPI can't connect to database yet, waiting more..."
            sleep 10
            docker compose exec -T fastapi python -c "from api.database import engine; engine.connect()" || {
              echo "âŒ FastAPI database connection failed"
              docker compose logs fastapi
              exit 1
            }
          fi
          
          echo "âœ“ All services are healthy"

      - name: Install test dependencies in container
        run: |
          echo "ðŸ“¦ Installing pytest and coverage tools..."
          docker compose exec -T fastapi pip install pytest pytest-cov

      - name: Run pytest in Docker container
        run: |
          echo "ðŸ§ª Running tests in Docker container..."
          mkdir -p reports
          docker compose exec -T fastapi pytest -v \
            --junitxml=/code/reports/pytest-junit.xml \
            --cov=api \
            --cov-report=xml:/code/reports/coverage.xml \
            --cov-report=term \
            --cov-report=html:/code/reports/htmlcov

      - name: Copy test reports from container
        if: always()
        run: |
          echo "ðŸ“‹ Copying reports from container..."
          docker cp $(docker compose ps -q fastapi):/code/reports ./reports 2>/dev/null || {
            echo "âš ï¸  Could not copy reports from /code/reports"
            # Essayer un chemin alternatif
            docker compose exec -T fastapi find / -name "pytest-junit.xml" 2>/dev/null || true
          }

      - name: Upload test reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: unit-test-reports
          path: reports/
          retention-days: 30

      - name: Upload coverage report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: reports/htmlcov/
          retention-days: 30
          if-no-files-found: warn

      - name: Comment PR with coverage
        if: github.event_name == 'pull_request' && hashFiles('reports/coverage.xml') != ''
        uses: orgoro/coverage@v3.1
        with:
          coverageFile: reports/coverage.xml
          token: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true

      - name: Display logs on failure
        if: failure()
        run: |
          echo "=== FastAPI Logs ==="
          docker compose logs fastapi --tail=200
          echo ""
          echo "=== MariaDB Logs ==="
          docker compose logs db --tail=100

      - name: Cleanup after unit tests
        if: always()
        run: |
          echo "ðŸ§¹ Cleaning up unit test containers..."
          docker compose down -v


  perf-tests:
    name: Performance tests (k6) + KPI report
    runs-on: ubuntu-latest
    needs: unit-tests

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Start database with seeding
        env:
          SEED_DB: "true"
          SEED_ADMIN: "true"
          ADMIN_EMAIL: "admin@digicheese.com"
          ADMIN_PASSWORD: "Admin123!"
        run: |
          echo "ðŸ—„ï¸ Starting MariaDB..."
          docker compose up -d db
          
          echo "â³ Waiting for MariaDB to be ready..."
          for i in {1..60}; do
            if docker compose exec -T db mysqladmin ping -h localhost -u admin -pAdmin123! --silent 2>/dev/null; then
              echo "âœ“ MariaDB is ready ($i attempts)"
              break
            fi
            if [ $i -eq 60 ]; then
              echo "âŒ MariaDB failed to start"
              docker compose logs db
              exit 1
            fi
            sleep 2
          done
          
          # Attente supplÃ©mentaire pour stabilisation
          sleep 5

      - name: Start FastAPI with seeding
        env:
          SEED_DB: "true"
          SEED_ADMIN: "true"
          ADMIN_EMAIL: "admin@digicheese.com"
          ADMIN_PASSWORD: "Admin123!"
        run: |
          echo "ðŸš€ Starting FastAPI with seeding..."
          docker compose up -d --build fastapi
          
          echo "â³ Waiting for seeding to complete (may take time)..."
          sleep 30
          
          echo "ðŸ“Š Container status:"
          docker compose ps
          
          echo "ðŸ“ FastAPI logs:"
          docker compose logs fastapi --tail=50

      - name: Wait for API health
        run: |
          echo "ðŸ” Checking API health..."
          for i in {1..90}; do
            if curl -sSf http://localhost:8000/docs > /dev/null 2>&1; then
              echo "âœ“ API is up and responding ($i attempts)"
              exit 0
            fi
            echo "Waiting for API... ($i/90)"
            sleep 2
          done
          
          echo "âŒ API did not start in time"
          echo "=== FastAPI Logs ==="
          docker compose logs fastapi --tail=200
          echo ""
          echo "=== MariaDB Logs ==="
          docker compose logs db --tail=100
          exit 1

      - name: Verify API endpoints
        run: |
          echo "ðŸ§ª Testing API endpoints..."
          curl -s http://localhost:8000/docs | head -20
          echo ""
          echo "âœ“ API is responding"

      - name: Prepare performance test directories
        run: |
          mkdir -p performance/results reports
          chmod -R 777 performance/results reports

      - name: Run k6 performance tests
        run: |
          # Fonction pour lancer k6
          run_k6_test() {
            local vus=$1
            local duration=$2
            local label=$3
            
            echo "ðŸ“Š Running k6 with ${vus} VUs (${label})..."
            docker run --rm --network host \
              -v "${PWD}:/work" -w /work \
              grafana/k6 run performance/test.js \
              --vus ${vus} \
              --duration ${duration} \
              -e BASE_URL="http://localhost:8000" \
              -e API_PREFIX="/api/v1" \
              -e EMAIL="admin@digicheese.com" \
              -e PASSWORD="Admin123!" \
              --out json=performance/results/k6_${vus}.json \
              --summary-export=performance/results/summary_${vus}.json
          }
          
          # Baseline test
          run_k6_test 10 30s "baseline"
          
          # Standard load test
          run_k6_test 50 30s "standard load"
          
          # Stress test (peut Ã©chouer)
          run_k6_test 100 30s "stress test" || {
            echo "âš ï¸ 100 VUs test failed (expected for stress test)"
          }

      - name: Generate KPI report
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install report dependencies and generate
        run: |
          pip install --upgrade pip
          pip install pandas tabulate 2>/dev/null || true
          
          echo "ðŸ“Š Generating performance report..."
          
          if [ -f "performance/ci/parse_k6.py" ]; then
            python performance/ci/parse_k6.py \
              --input performance/results \
              --output reports || create_fallback_report
          else
            create_fallback_report
          fi
          
          # Fonction pour crÃ©er un rapport de secours
          create_fallback_report() {
            cat > reports/REPORT.md << 'EOF'
          # ðŸ“Š Performance Test Results
          
          Performance tests completed successfully.
          
          ## Test Scenarios Executed
          - âœ… **10 VUs** - Baseline performance
          - âœ… **50 VUs** - Standard load
          - âš ï¸ **100 VUs** - Stress test (may have warnings)
          
          ## ðŸ“¦ Detailed Results
          Detailed JSON results are available in the artifacts for further analysis.
          Download the `perf-reports` artifact to view complete metrics.
          
          ## ðŸŽ¯ Next Steps
          1. Review detailed k6 JSON files in artifacts
          2. Analyze response times and throughput
          3. Compare against your SLA requirements
          4. Investigate any failures in the 100 VU test
          EOF
          }

      - name: Display generated report
        if: always()
        run: |
          if [ -f "reports/REPORT.md" ]; then
            echo "=== Performance Report ==="
            cat reports/REPORT.md
            echo "==================================="
          fi

      - name: Comment PR with performance results
        if: github.event_name == 'pull_request' && hashFiles('reports/REPORT.md') != ''
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          path: reports/REPORT.md
          header: performance-kpi
        continue-on-error: true

      - name: Upload performance artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: perf-reports
          path: |
            performance/results/
            reports/
          retention-days: 30

      - name: Display logs on failure
        if: failure()
        run: |
          echo "=== FastAPI Logs ==="
          docker compose logs fastapi --tail=200
          echo ""
          echo "=== MariaDB Logs ==="
          docker compose logs db --tail=100

      - name: Cleanup
        if: always()
        run: |
          echo "ðŸ§¹ Cleaning up..."
          docker compose down -v
          docker system prune -f || true